% !TEX TS-program = pdflatex
% !TEX encoding = UTF-8 Unicode

%tells you if you use obsolete packages
%\RequirePackage[l2tabu,orthodox]{nag}

\documentclass[]{article}

\usepackage[utf8]{inputenc} % set input encoding (not needed with XeLaTeX)

%%% PAGE DIMENSIONS
\usepackage{geometry} % to change the page dimensions
\geometry{a4paper} % or letterpaper (US) or a5paper or....
% \geometry{margin=2in} % for example, change the margins to 2 inches all round
% \geometry{landscape} % set up the page for landscape
%   read geometry.pdf for detailed page layout information

\usepackage{graphicx} % support the \includegraphics command and options

% \usepackage[parfill]{parskip} % Activate to begin paragraphs with an empty line rather than an indent

%%% PACKAGES
\usepackage{booktabs} % for much better looking tables
\usepackage{array} % for better arrays (eg matrices) in maths
\usepackage{paralist} % very flexible & customisable lists (eg. enumerate/itemize, etc.)
\usepackage{verbatim} % adds environment for commenting out blocks of text & for better verbatim
\usepackage{subfig} % make it possible to include more than one captioned figure/table in a single float
\usepackage{microtype} %makes awesome kerning and punctuation come half way out the edge of the text
\usepackage{listings} %for code listings
\usepackage{color} %for colored syntax highligting
\usepackage{rotating}
\usepackage{pdflscape}
\usepackage[]{algorithm2e}
\usepackage{multirow}
\usepackage{float}
\usepackage{mathtools}

\usepackage{caption}
\captionsetup[subfigure]{format=subfig,labelsep=colon,labelformat=simple}

%%% Code listing
\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}
\lstset{
basicstyle=\footnotesize\ttfamily,
commentstyle=\color{mygreen},
keywordstyle=\color{blue},
numberstyle=\tiny\color{mygray},
numbers=left,
tabsize=2,
frame=tb,
aboveskip=3mm,
belowskip=3mm,
breaklines=true,
breakatwhitespace=true,
showstringspaces=false,
columns=flexible
}

% to include a file as a listing: \lstinputlisting{intio.c}
% inline listing: \begin{lstlisting}[frame=single]

%%% HEADERS & FOOTERS
\usepackage{fancyhdr} % This should be set AFTER setting up the page geometry
\pagestyle{fancy} % options: empty , plain , fancy
\renewcommand{\headrulewidth}{0pt} % customise the layout...
\lhead{}\chead{}\rhead{}
\lfoot{}\cfoot{\thepage}\rfoot{}

%%% ToC (table of contents) APPEARANCE
\usepackage[nottoc,notlof,notlot]{tocbibind} % Put the bibliography in the ToC
\usepackage[titles,subfigure]{tocloft} % Alter the style of the Table of Contents
%\renewcommand{\cftsecfont}{\rmfamily\mdseries\upshape}
%\renewcommand{\cftsecpagefont}{\rmfamily\mdseries\upshape} % No bold!
\usepackage{hyperref} % use hyperlinked ToC
\hypersetup{colorlinks=true, linkcolor=black, citecolor=black, filecolor=black, urlcolor=black}

%%%-------------------------------------------------------------------


\title{Third Year Group Project \\ State Estimation for Indoor Environments}
\author{Oskar Weigl, Ryan Savatski, Thomas Morrison, Chinemelu Ezeh, Joshua Elsdon}
\begin{document}
\maketitle
\center{\textbf{\large{\emph{"...a profound trust in the advances of science."}	}}}

\abstract{
A Lovely Abstract full of insight and long words that makes it apparent we did lots of stuff 
\tableofcontents
\clearpage

\section{Executive Summary} % (fold)
\label{sec:executive_summary}

Summarise things in a summarative way, as if one were producing a summary for an executive. 

% section executive_summary (end)

\section{Introduction}  % (fold)
\label{sec:introduction}
Introduction introducing things in an introductory manner. 

% section introduction (end)

\section{Feature Extraction} % (fold)
\label{sec:feature_extraction}

\subsection{Sensor Calibration} % (fold)
\label{sub:sensor_calibration}

Multidimensional least squares correction
measure a plane at a known distance (d)
least squares establish the observed plane that matches this distance d
	(or just least squares the plane first??)
the distance of each point from the plane is the true calibration vector field projected onto the normal of the observed plane (in the camera's coordinate system)

% subsection sensor_calibration (end)

% section feature_extraction (end)

\clearpage %temp!
\section{EKF} % (fold)
\label{sec:ekf}


We use a kalman filter... the optimal state estimator
non linear due to rotations -- ekf
	euler vs runge kutta integrator
		very complicated linearization equations
			can be overcome with unscented kalman
		euler is fine if sampling fast enough
			if deltaT is small

de facto standard (cite)


\begin{align}
	x_k &= f(x_{k-1}, u_{k-1}) + w_{k-1} \notag \\
	y_k &= h(x_k) + v_k
	\label{eqn:system}
\end{align}

and define

\begin{align}
	P_{k|i} &= \operatorname{cov}(x_k - \hat{x}_{k|i})
\end{align}

we also have that

\begin{align}
	w_k &\sim N(0,Q_k) \notag \\
	v_k &\sim N(0,R_k) \notag \\
	x_0 &\sim N(\hat{x}_0,P_0)
\end{align}

where $Q_k$ and $R_k$ are the ... bla.. respectivly.

The sucessive approximation... predict stage..

\begin{align}
	\hat{x}_{k|k-1} &= f(\hat{x}_{k-1|k-1}, u_{k-1}) \notag \\
	P_{k|k-1} 		&\approx F_{k-1} P_{k|k} F_{k-1}^\top + Q_{k}
\end{align}

where

\begin{align}
	F_{k-1} &= \left . \frac{\partial f(x,u)}{\partial x} \right \vert _{\hat{x}_{k-1|k-1},u_{k-1}}
\end{align}

update stage...

\begin{align}
	z_k 		&= y_k - h(\hat{x}_{k|k-1}) \\
	S_k 			&= \operatorname{cov}(z_k) \notag \\
	S_k 			&\approx H_k P_{k|k-1} H_k^\top + R_k \\
	K_k 			&= P_{k|k-1} H_k^\top S_k^{-1} \\
	\hat{x}_{k|k} 	&= \hat{x}_{k|k-1} + K_k z_k \\
	P_{k|k} 		&\approx (I - K_k H_k) P_{k|k-1}
\end{align}

where

\begin{align}
	H_{k} &= \left . \frac{\partial h(x)}{\partial x} \right \vert _{\hat{x}_{k|k-1}}
\end{align}

Model equations..

\begin{align}
	\Xi(\vec{q}) &=
	\left[
	\begin{matrix}
		-q_1 	& -q_2	& -q_3 	\\
		q_0		& -q_3 	& q_2 	\\
		q_3 	& q_0 	& -q_1 	\\
		-q_2 	& q_1 	& q_0
	\end{matrix}
	\right]
\end{align}

\begin{align}
	\Omega(\vec{\omega}) &=
	\left[
	\begin{matrix}
		0 			& -\omega_x 	& -\omega_y	& -\omega_z	\\
		\omega_x 	& 0 			& \omega_z 	& -\omega_y \\
		\omega_y 	& -\omega_z 	& 0 		& \omega_x 	\\
		\omega_z 	& \omega_y		& -\omega_x & 0
	\end{matrix}
	\right]
\end{align}

\begin{align}
	\dot{q} 	&= \frac{1}{2} \Omega(\omega) q \\
				&= \frac{1}{2} \Xi(q) \omega
\end{align}

The derivation of the rate of change of the quaternion with respect to angular velocity in the body frame can be found in \cite{MARSlab} (see equation 108). Note that they use the convetion q = q4 + q1i + q2j + q3k, while we use the convention q0 + q1i + q2j + q3k, which is the same convetion used by MATLAB's Aerospace Blockset \cite{MATLABAerospace}.

\begin{align}
	\vec{q} &= q_0 + q_1i + q_2j + q_3k
\end{align}

Rbe (rotation of body with respect to earth)
rotmatrix here.

\begin{align}
	R_{be}(\vec{q}) &=
	\left[
	\begin{matrix}
		2(q_0^2 + q_1^2) - 1 	& 2(q_1 q_2 + q_0 q_3) 	& 2(q_1 q_3 - q_0 q_2) \\
		2(q_1 q_2 - q_0 q_3) 	& 2(q_0^2 + q_2^2) - 1 	& 2(q_2 q_3 + q_0 q_1) \\
		2(q_1 q_3 + q_0 q_2)	& 2(q_2 q_3 - q_0 q_1)	& 2(q_0^2 + q_3^2) - 1
	\end{matrix}
	\right]
\end{align}

The derivation of the quaternion derived rotation matrix is also shown in \cite{MARSlab} (see equation 91)

as a rotation matrix is orthogonal, we have that

\begin{align}
	R_{eb} &= R_{be}^\top
\end{align}

Linearisation: Jacobians

\begin{align}
	\frac{\partial f(x,u)}{\partial x}
\end{align}


SerialUpdate: \cite{OpenPilotPaper} and chapter 4.2.2 of \cite{KFBookSerialupdate}
The referenced papers perform an optimization which assumes an entirerly uncorrelated measurment noise covariance matrix. That is the $R$ matrix is purely diagonal.
We, on the other hand, use a measurment model that includes the measurment of planes. These measurements consist of the estimated plane equation in hessian normal form. As the plane is in a three dimensional space, and thus the measurment error will have three degrees of freedom, and this form has four dimensions, the covariance matrix cannot be uncorrelated.
That is, as the hessian normal form uses a unit vector, the length of this vector is bound to unity. As such, the probability distrubution of the error of the components of this normal vector cannot be spherical.
In fact, after linearization, this distrubution is projected onto a plane tangential to the actual distrubution. 
%TODO: insert picture of distrubution projected onto plane

While we cannot serialise the individual componets of a plane measurment, the measurment error between planes are uncorrelated, so we can still make use of the serial update strategy. As such, at each time there is a new frame that has finished feature extraction, we serially apply the measurment updates for each plane, without running the predict loop in-between.
That means the update stage will only have to invert $v 4\times4$ matricies, instead of inverting a $4v \times 4v$ matrix.

\subsection{Impementation} % (fold)
\label{sub:impementation}

We crosscheck our implementation against a similar open source implementation by the OpenPilot team \cite{OpenPilotinsgps}.

% subsection impementation (end)

% section ekf (end)

\clearpage
\begin{thebibliography}{99}

\bibitem{MARSlab}
	Nikolas Trawny and Stergios I. Roumeliotis,
	\emph{Indirect Kalman Filter for 3D Attitude Estimation, A Tutorial for Quaternion Algebra}. \\
	\url{http://www-users.cs.umn.edu/~trawny/Publications/Quaternions_3D.pdf}

\bibitem{MATLABAerospace}
	MathWorks,
	\emph{Implement quaternion representation of six-degrees-of-freedom equations of motion with respect to body axes}. \\
	\url{http://www.mathworks.co.uk/help/aeroblks/6dofquaternion.html}

\bibitem{OpenPilotPaper}
	Dale E. Schinstock,
	\emph{GPS-aided INS Solution for OpenPilot}. \\
	\url{http://wiki.openpilot.org/download/attachments/950387/INSGPSAlg.pdf}

\bibitem{KFBookSerialupdate}
	Grewal, M.S., A.P. Andrews,
	\emph{Kalman Filtering, Theory and Practice Using MATLAB}. \\
	\url{http://www.control.aau.dk/~obin03/ESIF/Grewal,%20Andrews%20Kalman%20Filtering%20Theory%20And%20Practice%20Using%20Matlab%20(2Ed%20,%20Wiley,%202001)(410S).pdf}

\bibitem{OpenPilotinsgps}
	The OpenPilot Team,
	\emph{Joint attitude and position estimation EKF}. \\
	\url{http://reviews.openpilot.org/browse/OpenPilot/flight/libraries/insgps16state.c?hb=true}

\bibitem{ThirdYearControl}
	Alessandro Astolfi,
	\emph{Systems and Control Theory - An Introduction}. \\
	\url{http://www3.imperial.ac.uk/pls/portallive/docs/1/31851696.PDF}

\end{thebibliography}

\end{document}